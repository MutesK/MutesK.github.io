<!DOCTYPE html><html lang="ko-KR"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="JunMin Kim, j0803@naver.com"><title>Select 모델, ASyncSelect · Mute의 개발 블로그</title><!-- hexo-inject:begin --><!-- hexo-inject:end --><meta name="description" content="Select 함수
제일 먼저 등장한 입출력 다중화 모델.

예전에는 하나의 포트당 프로그램을 하나씩 동작하여 처리함. 하나의 프로세스에서 여러개의 디바이스 처리를 위해 등장

블록킹 소켓 사용 효과

소켓 함수 호출시, 조건 만족이 되지 않아서 블록되는 상황을 막는다."><meta name="keywords" content="C++,C,PHP,Windows OS"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Mute의 개발 블로그</a></h3><div class="description"><p>게임 서버 개발 및 각종개발기술 공부</p></div></div></div><ul class="social-links"><li><a href="http://github.com/MutesK"><i class="fa fa-github"></i></a></li></ul></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">홈</a></li><li><a href="/about">정보</a></li><li><a href="/archives">아카이브</a></li><li><a href="/links">포트폴리오 링크</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Select 모델, ASyncSelect</a></h3></div><div class="post-content"><h1 id="Select-함수"><a href="#Select-함수" class="headerlink" title="Select 함수"></a>Select 함수</h1><blockquote>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><p>제일 먼저 등장한 입출력 다중화 모델.</p>
</blockquote>
<p><em>예전에는 하나의 포트당 프로그램을 하나씩 동작하여 처리함. 하나의 프로세스에서 여러개의 디바이스 처리를 위해 등장</em></p>
<ol>
<li><p>블록킹 소켓 사용 효과</p>
<ul>
<li>소켓 함수 호출시, 조건 만족이 되지 않아서 블록되는 상황을 막는다.</li>
</ul>
</li>
<li><p>넌블록킹 소켓 사용 효과</p>
<ul>
<li>조건이 만족되지 않아서, 나중에 다시 호출하지 않아도 된다.</li>
</ul>
</li>
</ol>
<h2 id="Select-동작"><a href="#Select-동작" class="headerlink" title="Select 동작"></a>Select 동작</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Select 모델을 사용하려면 소켓 셋 3개를 준비한다.</span><br><span class="line"></span><br><span class="line">소켓 셋은 읽기 셋, 쓰기 셋, 예외 셋으로 이루어져 있다.</span><br><span class="line"></span><br><span class="line">호출할 함수의 종류에 따라 소켓을 적당한 셋에 넣는다.</span><br><span class="line">소켓 셋 준비후, Select 호출하면, Select 함수는 소켓 셋에 포함된 소켓이 입출력을 위한 준비가 될때까지 대기한다.</span><br><span class="line"></span><br><span class="line">적어도 하나의 소켓이 준비되면 리턴, IO가 가능한 소켓만이 남는다.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>IO완료를 통지받지 않고, Event Loop을 통해 소켓 상태를 검사하므로 동기식 입출력</p>
</blockquote>
<blockquote>
<p>타임아웃을 설정한 경우, 넘어가므로 논블록킹 소켓</p>
</blockquote>
<ul>
<li><p>장점</p>
<ul>
<li>모든 OS에서 지원하므로 이식성이 좋다.</li>
</ul>
</li>
<li><p>단점</p>
<ul>
<li>스레드당 처리가능한 소켓의 갯수가 정해져 있다. ( FD_SETSIZE로 처리가능한 수를 늘릴수 있음)</li>
<li>하위 호환성을 위해 존재한다. 소켓 입출력 모델중 가장 느리다. (소켓 상태를 다 검사해야된다.)</li>
</ul>
</li>
</ul>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">```cpp</span><br><span class="line"></span><br><span class="line">Client</span><br><span class="line">&#123;</span><br><span class="line">  ID, X, Y</span><br><span class="line">  SOCKET  <span class="comment">// 초기값 INVALID_SOCKET으로 초기화</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Client g_client[<span class="number">30</span>];</span><br><span class="line">SOCKET g_ListenSocket;  <span class="comment">// 여기로 Accept 해주면 된다.</span></span><br><span class="line">ID = x(특정값);  <span class="comment">// 세션마다 고유한 번호를 매겨야 된다. -&gt; 쓰레드환경이면 중복값이 나올수 있다.</span></span><br><span class="line"><span class="comment">// 특정값부터 + 1씩 해나간다. (Unique한 값으로)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// 서버 준비</span></span><br><span class="line">   <span class="comment">// Startup, Bind, 등등.. 네트워크 초기화 작업</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span>()</span><br><span class="line">   &#123;</span><br><span class="line">     NetworkProcess()</span><br><span class="line">     Draw()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NetworkProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 이 소켓이 접속자인지 확인뒤 FD_SET에 넣는다.</span></span><br><span class="line">  FD_SET ReadSet;</span><br><span class="line">  Timeval time; <span class="comment">// 0,0</span></span><br><span class="line">  FD_ZERO(&amp;ReadSet);</span><br><span class="line">  FD_SET(g_ListenSocket, &amp;ReadSet);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="number">0</span>~<span class="number">29</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(접속자[n])</span><br><span class="line">    &#123;</span><br><span class="line">      FD_SET(접속자[n]소켓, &amp;ReadSet);</span><br><span class="line">      re = Select(<span class="number">0</span>, &amp;ReadSet, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;time);</span><br><span class="line">      <span class="keyword">if</span>(re &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(FD_ISSET(g_ListenSocket, &amp;ReadSet))</span><br><span class="line">        &#123;</span><br><span class="line">            Socket = Accept(g_ListenSocket, addr .... );</span><br><span class="line">            신규접속자처리(Socket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Listen</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="number">0</span> ~ <span class="number">29</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(접속여부 확인[N] &amp;&amp; FD_ISSET(소켓, &amp;ReadSet))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">int</span> packet[<span class="number">4</span>];</span><br><span class="line">      ret = recvn(소켓, packet, <span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span>(ret == <span class="number">0</span> || ret == SOCKET_ERROR)</span><br><span class="line">        접속해제(N);</span><br><span class="line">      패킷처리(N, Packet);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 함수</span><br><span class="line">신규접속자(Socket)</span><br><span class="line">&#123;</span><br><span class="line">  빈 클라이언트 구조체 탐색</span><br><span class="line">  Client[N].Socket = Socket;</span><br><span class="line">  [N].ID = g_ID++;</span><br><span class="line">  .X = ?</span><br><span class="line">  .Y = ?</span><br><span class="line"></span><br><span class="line">  Packet[<span class="number">1</span>].g_ID;</span><br><span class="line">  Packet[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  ret = Send(Socket, Packet, <span class="number">16</span> , <span class="number">0</span>);  <span class="comment">// ID 할당 파트</span></span><br><span class="line">  <span class="keyword">if</span>(ret == <span class="number">0</span> || ret == SOCKET_ERROR)</span><br><span class="line">    접속해제(N);</span><br><span class="line">  <span class="comment">// 신규 접속 파트</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="number">0</span> ~ <span class="number">29</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(Client[N] 확인)</span><br><span class="line">    &#123;</span><br><span class="line">      Packet[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">      Packet[<span class="number">1</span>] = g_ID;</span><br><span class="line">      Packet[<span class="number">2</span>] = X</span><br><span class="line">      Packet[<span class="number">3</span>] = Y;</span><br><span class="line"></span><br><span class="line">      ret = Send(Socket, Packet, <span class="number">16</span> , <span class="number">0</span>);  <span class="comment">// ID 할당 파트</span></span><br><span class="line">      <span class="keyword">if</span>(ret == <span class="number">0</span> || ret == SOCKET_ERROR)</span><br><span class="line">        접속해제(N);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">접속해제(index)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 접속 해제 감지 방법 recv, send</span></span><br><span class="line">  CloseSocket(client[index].Socket);</span><br><span class="line">  Client[index] 초기화</span><br><span class="line">&#125;</span><br><span class="line">패킷처리(Index, packet)</span><br></pre></td></tr></table></figure>
<h1 id="ASyncSelect"><a href="#ASyncSelect" class="headerlink" title="ASyncSelect"></a>ASyncSelect</h1><ul>
<li>소켓 함수 호출시 성공할수 있는 시점을 윈도우 메세지 수신으로 알수있다.<blockquote>
<p>멀티스레드를 사용하지 않아도, 여러개의 소켓 처리가 가능(멀티스레드가 쓰기가 애매해진다.)</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>윈도우 메세지를 통해, 비동기적으로 소켓활용 가능</p>
</blockquote>
<ul>
<li>장점<ul>
<li>소켓 이벤트를 윈도우 메세지 형태로 처리하므로, GUI와 결합이 가능.</li>
</ul>
</li>
<li><p>단점</p>
<ul>
<li>하나의 윈도우 프로시저에서 일반 윈도우 메세지와 소켓 메세지를 처리해야하므로, 성능저하의 원인이 된다.</li>
<li>윈도우 큐 메세지에는 한도가 있다. 같이 쓰다보니, 오버플로우 될수 있다.</li>
<li>멀티스레드를 쓰기 힘든 구조</li>
</ul>
</li>
<li><p>유의할점</p>
<ul>
<li>WSAASyncSelect을 사용하면 해당 소켓은 자동으로 넌블럭킹 소켓</li>
<li>accpet 함수가 리턴하는 소켓은 연결대기 소켓과 동일한 속성을 갖게된다.<ul>
<li>연결대기 소켓은 데이터송수신 하지않으므로, FD_READ, FD_WIRTE를 처리하지 않는다.</li>
<li>다시 WSAASyncSelect 호출하여 이벤트를 등록해야된다.</li>
</ul>
</li>
<li>윈도우메세지를 받았을때, 소켓함수를 호출하지않으면, 다음번에는 윈도우메세지가 발생하지않는다. <ul>
<li>대응함수를 호출하거나, 직접 메세지를 발생시켜야 된다.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">WinMain()</span><br><span class="line">&#123;</span><br><span class="line">     Dialog IP 받기</span><br><span class="line">          <span class="comment">// Connect 하기전에 AsyncSelect를 해야된다.</span></span><br><span class="line">     <span class="comment">// 1. 소켓 생성</span></span><br><span class="line">     <span class="comment">// 2. 윈도우 생성</span></span><br><span class="line">     WSAASyncSelect(socket, hWnd, UM_MESSAGE, FD_CONNECT | FD_READ | FD_WRITE | FD_CLOSE);</span><br><span class="line">     err = connect();</span><br><span class="line">     <span class="keyword">if</span>(WSAGetLastError() != WSAWOULDBLOCK)</span><br><span class="line">     &#123;</span><br><span class="line">        <span class="comment">// 진짜 에러 -&gt; 종료</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// FD_CONNECT  신호가 오면 진짜로 연결된거다!. bConnect 플래그가 필요하다. FD_CONNECT가 뜨면 이 플래그를 TRUE로 전환한다.</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 메세지 루프</span></span><br><span class="line">     <span class="keyword">if</span>(bConnect)</span><br><span class="line">     &#123;</span><br><span class="line">        </span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WndProc()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">switch</span>()</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_MOUSEMOVE:</span><br><span class="line">      <span class="keyword">if</span> 마우스 클릭중이라면</span><br><span class="line">        SendDraw(위치 전송);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> UM_NETWORK:</span><br><span class="line">       에러 체크</span><br><span class="line">       <span class="keyword">switch</span>(이벤트 lParam)</span><br><span class="line">       &#123;</span><br><span class="line">         <span class="keyword">case</span> FD_CONNECT:</span><br><span class="line">            <span class="comment">// 진짜 연결 플래그 전환</span></span><br><span class="line">            bConnect = <span class="literal">true</span>;</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> FD_CLOSE:</span><br><span class="line">          <span class="comment">// 종료.</span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> FD_READ:</span><br><span class="line">          RecvEvent();</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> FD_WRITE: <span class="comment">// 첫 접속시, WSAWouldblock상태에서 전송가능상태로 전환된경우(버퍼가 비어질때)</span></span><br><span class="line">         SendFlag = <span class="literal">true</span>;</span><br><span class="line">         SendEvent();</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SendDraw(Sx, Sy, Ex, Ey)</span><br><span class="line">&#123;</span><br><span class="line">  SendQ에 넣기 작업</span><br><span class="line">  SendPacket(); <span class="comment">// SendQ에 있는 버퍼를 보내는 함수, FD_WRITE가 떳을때에도 이 함수를 호출한다.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SendEvent() == SendEvent()</span><br><span class="line">&#123;</span><br><span class="line">      <span class="keyword">if</span>(SendFlag == <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      WSABUF wsabuf[<span class="number">2</span>]</span><br><span class="line">      <span class="comment">// 셋팅</span></span><br><span class="line">     <span class="comment">// sendSize = 0으로 초기화</span></span><br><span class="line">      ret = WSAEvent(Socket, &amp;wsabuf, bufcount, &amp;sendSize, &amp;flag, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(ret == SOCKET_ERROR)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">if</span>(WSAGetLastError() == WSAWOULDBLOCK)</span><br><span class="line">          &#123;</span><br><span class="line">            SendFlag = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    SendQ.Remove(SendSize);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RecvEvent()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> bufcount = <span class="number">1</span>;</span><br><span class="line">    WSABUF wsabuf[<span class="number">2</span>];</span><br><span class="line">    wsabuf[<span class="number">0</span>].len = 한방에 안끊기고 받을수 있는 사이즈</span><br><span class="line">    wsabuf[<span class="number">0</span>].buff = 쓰기에 대한 포인터</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(RecvQ.GetNotBrokenPutSize() &lt; RecvQ.GetFreeSize())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 아직 공간이 남았다면</span></span><br><span class="line">        wsabuf[<span class="number">1</span>].len = 길이</span><br><span class="line">        wsabuf[<span class="number">1</span>].buff = RecvQ의 시작 포인터</span><br><span class="line">        bufcount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DWORD RecvSize = <span class="number">0</span>;  <span class="comment">// Out</span></span><br><span class="line">    DWORD Flag = <span class="number">0</span>;  <span class="comment">// In</span></span><br><span class="line">    ret = WSARecv(sock, &amp;wsabuf, <span class="number">2</span>, &amp;RecvSize, &amp;Flag, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 방법 1.</span></span><br><span class="line">    <span class="keyword">if</span>(ret == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// WSAGetLastError 체크</span></span><br><span class="line">        DWORD Error = WSAGetLastError();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(Error != WSAWOULDBLOCK)</span><br><span class="line">        &#123;</span><br><span class="line">           끊기</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 방법 2.</span></span><br><span class="line">    <span class="keyword">if</span>(RecvSize == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">// 끊기</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RecvSize 크기만큼 m_rear 위치 변경</span><br><span class="line">    RecvQ.MoveWritePos(RecvSize);</span><br><span class="line">    PacketProc(); <span class="comment">// 패킷 처리 -&gt; 그리기</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PacketProc()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> len;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span>(RecvQ.GetUseSize() &lt; <span class="number">2</span>) <span class="comment">// 최소한 헤더 크기 이상</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      RecvQ.Peek(&amp;len, <span class="number">2</span>);  <span class="comment">// 헤더만큼 가져온다.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(RecvQ.GetUseSize() &lt; len + <span class="number">2</span>)   <span class="comment">// 사용한 데이터 &lt; 헤더 크기 + 2 라면 완성이 안되어있다.</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      RecvQ.RemoveData(<span class="number">2</span>); <span class="comment">// 헤더만큼 큐에서 지운다.</span></span><br><span class="line">      RecvQ.Get(&amp;Packet, len);</span><br><span class="line">      Draw(-);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-03-21</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Winsock/" title="Winsock">Winsock </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://Mutesk.github.io/2018/03/21/Select_Model/,Mute의 개발 블로그,Select 모델, ASyncSelect,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2018/03/21/OverlappedIO/" title="Overlapped I/O">이전 포스트</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/03/21/Socket_Programming/" title="소켓 함수">다음 포스트</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify: || false, 
  verify:|| false, 
  app_id:'',
  app_key:'',
  placeholder:'',
  path: window.location.pathname,
  avatar:''
})</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>